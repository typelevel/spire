<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Typelevel Laika + Helium Theme" />
  <title>Design</title>
  
  <meta name="author" content="Erik Osheim"/>
  
  <meta name="author" content="Tom Switzer"/>
  
  
  <meta name="description" content="docs"/>
  
  
  
  <link rel="icon" sizes="32x32" type="image/png" href="https://typelevel.org/img/favicon.png"/>
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:500">
  
  <link rel="stylesheet" type="text/css" href="helium/site/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="helium/site/laika-helium.css" />
  <script src="helium/site/laika-helium.js"></script>
  
  
  <script> /* for avoiding page load transitions */ </script>
</head>

  <body>

    <header id="top-bar" class="light-default dark-default">

  <div class="row">
    <a id="nav-icon">
      <i class="icofont-laika navigationMenu" title="Navigation">&#xefa2;</i>
    </a>
    
    
  </div>

  <a class="image-link" href="https://typelevel.org"><img src="https://typelevel.org/img/logo.svg"></a>

  <div class="row links">
    
    <a class="icon-link svg-link" href="https://www.javadoc.io/doc/org.typelevel/spire_2.13/latest/spire/index.html"><span class="api" title="API"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M75,47.5c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm-50,-0c13.246,-0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,-0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm2.705,16.735l7.239,0l0.622,-4.904l-21.833,0l-0,4.904l7.589,0l0,22.067l6.383,0l-0,-22.067Zm58.076,7.265c-0,-8.757 -3.698,-14.166 -10.781,-14.166c-7.083,-0 -10.781,5.604 -10.781,14.166c0,8.757 3.698,14.166 10.781,14.166c7.083,0 10.781,-5.604 10.781,-14.166Zm-6.539,0c0,6.538 -1.128,9.496 -4.242,9.496c-2.997,0 -4.242,-2.88 -4.242,-9.496c-0,-6.616 1.206,-9.496 4.242,-9.496c3.036,-0 4.242,2.88 4.242,9.496Zm-29.242,-67c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm0.512,9.834c-7.122,-0 -12.609,5.098 -12.609,14.127c-0,9.263 5.215,14.205 12.532,14.205c4.164,0 7.083,-1.634 9.068,-3.658l-2.88,-3.697c-1.518,1.206 -3.153,2.413 -5.838,2.413c-3.697,-0 -6.266,-2.763 -6.266,-9.263c-0,-6.616 2.724,-9.379 6.149,-9.379c2.102,-0 3.892,0.778 5.371,1.984l3.113,-3.775c-2.257,-1.868 -4.748,-2.957 -8.64,-2.957Z"/>
  </g>
</svg></span></a>
    
    <a class="icon-link svg-link" href="https://github.com/typelevel/spire"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
    <a class="icon-link glyph-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika chat" title="Chat">&#xeed5;</i></a>
    
    <a class="icon-link svg-link" href="https://fosstodon.org/@typelevel"><span class="mastodon" title="Mastodon"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <g class="svg-shape">
    <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/>
  </g>
</svg></span></a>
    
  </div>  

</header>
    
    <nav id="sidebar">

  <div class="row">
    
    <a class="icon-link svg-link" href="https://www.javadoc.io/doc/org.typelevel/spire_2.13/latest/spire/index.html"><span class="api" title="API"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M75,47.5c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm-50,-0c13.246,-0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,-0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm2.705,16.735l7.239,0l0.622,-4.904l-21.833,0l-0,4.904l7.589,0l0,22.067l6.383,0l-0,-22.067Zm58.076,7.265c-0,-8.757 -3.698,-14.166 -10.781,-14.166c-7.083,-0 -10.781,5.604 -10.781,14.166c0,8.757 3.698,14.166 10.781,14.166c7.083,0 10.781,-5.604 10.781,-14.166Zm-6.539,0c0,6.538 -1.128,9.496 -4.242,9.496c-2.997,0 -4.242,-2.88 -4.242,-9.496c-0,-6.616 1.206,-9.496 4.242,-9.496c3.036,-0 4.242,2.88 4.242,9.496Zm-29.242,-67c13.246,0 24,10.754 24,24c0,13.246 -10.754,24 -24,24c-13.246,0 -24,-10.754 -24,-24c0,-13.246 10.754,-24 24,-24Zm0.512,9.834c-7.122,-0 -12.609,5.098 -12.609,14.127c-0,9.263 5.215,14.205 12.532,14.205c4.164,0 7.083,-1.634 9.068,-3.658l-2.88,-3.697c-1.518,1.206 -3.153,2.413 -5.838,2.413c-3.697,-0 -6.266,-2.763 -6.266,-9.263c-0,-6.616 2.724,-9.379 6.149,-9.379c2.102,-0 3.892,0.778 5.371,1.984l3.113,-3.775c-2.257,-1.868 -4.748,-2.957 -8.64,-2.957Z"/>
  </g>
</svg></span></a>
    
    <a class="icon-link svg-link" href="https://github.com/typelevel/spire"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
    <a class="icon-link glyph-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika chat" title="Chat">&#xeed5;</i></a>
    
    <a class="icon-link svg-link" href="https://fosstodon.org/@typelevel"><span class="mastodon" title="Mastodon"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <g class="svg-shape">
    <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/>
  </g>
</svg></span></a>
    
  </div>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="index.html">Spire</a></li>
    <li class="level1 nav-leaf"><a href="guide.html">Spire User&#39;s Guide</a></li>
    <li class="level1 nav-leaf"><a href="CHANGES.html">Changes</a></li>
    <li class="level1 nav-leaf"><a href="CONTRIBUTING.html">Contributing to Spire</a></li>
    <li class="level1 active nav-leaf"><a href="#">Design</a></li>
    <li class="level1 nav-leaf"><a href="AUTHORS.html">Authors</a></li>
    <li class="level1 nav-leaf"><a href="FRIENDS.html">Friends of Spire</a></li>
  </ul>

</nav>

    <div id="container">

      
<nav id="page-nav">
  <p class="header"><a href="#">Design</a></p>

  <ul class="nav-list">
    <li class="level1 nav-node"><a href="#safelong">SafeLong</a></li>
    <li class="level2 nav-leaf"><a href="#invariants-1">Invariants</a></li>
    <li class="level2 nav-leaf"><a href="#implementation-notes-1">Implementation notes</a></li>
    <li class="level2 nav-leaf"><a href="#performance-tips-1">Performance tips</a></li>
    <li class="level1 nav-node"><a href="#rational">Rational</a></li>
    <li class="level2 nav-leaf"><a href="#invariants-2">Invariants</a></li>
    <li class="level2 nav-leaf"><a href="#implementation-notes-2">Implementation notes</a></li>
    <li class="level2 nav-leaf"><a href="#performance-tips-2">Performance tips</a></li>
  </ul>

  <p class="footer"></p>
</nav>


      <main class="content">

        <h1 id="design" class="title">Design</h1>
        <p>This document is intended to describe design goals, invariants and implementation notes for the various types</p>
        
        <h2 id="safelong" class="section"><a class="anchor-link left" href="#safelong"><i class="icofont-laika link">&#xef71;</i></a>SafeLong</h2>
        <p>The design goal of SafeLong is to provide worry-free arbitrary precision integers that nevertheless have performance approaching boxed Longs for calculations that remain within the range of a 64bit signed integer.</p>
        <p>This is achieved by having two cases: <code>SafeLongLong(x: Long)</code> is used for numbers within the long range. <code>SafeLongBigInt(x: BigInt)</code> is used if this is not the case.</p>
        
        <h3 id="invariants-1" class="section"><a class="anchor-link left" href="#invariants-1"><i class="icofont-laika link">&#xef71;</i></a>Invariants</h3>
        <ul>
          <li>A number in the long range must <em>always</em> be represented as a <code>SafeLongLong</code>. This is used both within the SafeLong operations and from other classes in spire.math. Consequences of this invariant are</li>
        </ul>
        <ul>
          <li><code>SafeLongBigInt</code> can never be zero</li>
        </ul>
        <ul>
          <li>A <code>SafeLongBigInt</code> can never be equal to a <code>SafeLongLong</code></li>
        </ul>
        
        <h3 id="implementation-notes-1" class="section"><a class="anchor-link left" href="#implementation-notes-1"><i class="icofont-laika link">&#xef71;</i></a>Implementation notes</h3>
        <p>Operations of <code>SafeLongBigInt</code> use the underyling BigInt and create the appropriate kind of result depending on whether the result is a valid long.</p>
        <p>Operations on <code>SafeLongLong</code> use the Checked macro to perform operations using long integers, and only fall back to using <code>BigInt</code> in case of numeric overflow.</p>
        
        <h3 id="performance-tips-1" class="section"><a class="anchor-link left" href="#performance-tips-1"><i class="icofont-laika link">&#xef71;</i></a>Performance tips</h3>
        <ul>
          <li>comparison to zero is more efficient using signum than using compare</li>
          <li>the <code>isValidLong</code> method can be used to check if a <code>SafeLong</code> can be losslessly converted to a long using <code>toLong</code></li>
        </ul>
        
        <h2 id="rational" class="section"><a class="anchor-link left" href="#rational"><i class="icofont-laika link">&#xef71;</i></a>Rational</h2>
        <p>The design goal of Rational is to provide good performance and low memory overhead in the very frequent case of rational numbers with small magnitude, while still being able to represent rational numbers of arbitrary size.</p>
        <p>To achieve this goal, there are two different cases. <code>LongRational(n: Long, d: Long)</code> is used to represent small
        rational numbers. <code>BigRational(n: BigInt, d: BigInt)</code> is used whenever either numerator or denominator are too large to be stored in a <code>LongRational</code>.</p>
        
        <h3 id="invariants-2" class="section"><a class="anchor-link left" href="#invariants-2"><i class="icofont-laika link">&#xef71;</i></a>Invariants</h3>
        <p>Rationals are always stored in a normalized form so that there is an unique representation for each number:</p>
        <ul>
          <li>Common factors of numerator and denominator are eliminated, so e.g. <code>3/9</code> is stored as <code>n = 1, d = 3</code></li>
          <li>Negative rational numbers are always stored as a negative numerator. Therefore the denominator is always positive</li>
          <li>A rational number with a zero denominator is invalid</li>
          <li>Zero will always be stored as <code>n = 0, d = 1</code></li>
        </ul>
        <p>In addition to these invariants that are quite common in many rational implementations, there are additional invariants
        related to the usage of LongRational or BigRational:</p>
        <ul>
          <li>Every rational number that can be stored in a LongRational given the invariants above will <em>always</em> be stored in a
          LongRational. Consequences of this are:</li>
        </ul>
        <ul>
          <li>The valid range for the numerator is <code>[Long.MinValue, Long.MaxValue]</code> and for the denominator <code>[1, Long.MaxValue]</code>.</li>
        </ul>
        <ul>
          <li>Since the denominator is always stored as a positive number, e.g. <code>Rational(1, Long.MinValue)</code> must be stored as a
          BigRational</li>
        </ul>
        <ul>
          <li>A BigRational can never be equal to a LongRational</li>
        </ul>
        <ul>
          <li>The numerator of a BigRational can never be zero, since zero is always represented as <code>LongRational(0, 1)</code></li>
        </ul>
        <p>When implementing operations for Rationals, it is important to make sure that the invariants are not violated. E.g. when performing an operation with two <code>BigRational</code> that results in a small number that can be represented in a
        <code>LongRational</code>, the result <strong><em>must</em></strong> be a <code>LongRational</code>.</p>
        
        <h3 id="implementation-notes-2" class="section"><a class="anchor-link left" href="#implementation-notes-2"><i class="icofont-laika link">&#xef71;</i></a>Implementation notes</h3>
        <p>The implementation of BigRational is pretty straightforward. Usually, operations will be performed using <code>SafeLong</code>, and the result will be created using a builder method that takes a <code>SafeLong</code> for both numerator and denominator and produces the right kind of rational number given the invariants.</p>
        <p>LongRational operations are a bit more complex: Basic operations use the Checked macro to try to perform the operation with just long integers, and only fall back to using <code>SafeLong</code> when there is a numeric overflow. The advantage of this approach is that there are no unnecessary object allocations in the very common case that there is no overflow.</p>
        
        <h3 id="performance-tips-2" class="section"><a class="anchor-link left" href="#performance-tips-2"><i class="icofont-laika link">&#xef71;</i></a>Performance tips</h3>
        <p>The performance characteristics of rational operations are a bit different to normal integer or floating point operations. </p>
        <ul>
          <li>the basic operations +,-,*,/ have roughly the same cost</li>
          <li>comparison is cheaper than the basic operations, and will not allocate any objects for small rational numbers</li>
          <li>comparison to zero is more efficient using signum than using compare</li>
          <li>comparison to one is best done with the compareToOne method instead of using compare</li>
        </ul>

        
<hr class="footer-rule"/>
<footer>
  spire is a <a href="https://typelevel.org/">Typelevel</a> project distributed under the <a href="https://opensource.org/licenses/MIT">MIT</a> license.
</footer>


      </main>

    </div>

  </body>

</html>